<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visit Management System</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase client library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS (xlsx) for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* Custom styles for a more polished and impressive UI */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }

        /* Page transition animations */
        .page { 
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; 
            width: 100%;
        }
        .page.hidden { 
            opacity: 0; 
            transform: translateY(10px); 
            pointer-events: none; 
            position: absolute; 
            top: 0;
            left: 0;
        }

        /* Custom focus ring for better accessibility */
        .focus-ring {
            transition: box-shadow 0.2s ease-in-out;
        }
        .focus-ring:focus-visible, .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        }

        /* Loading spinner animation */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Camera and photo styling */
        #cameraFeed { width: 100%; height: auto; border-radius: 0.5rem; transform: scaleX(-1); }
        #photoCanvas { display: none; }
        #photoPreview { width: 100%; max-width: 250px; height: auto; border-radius: 0.5rem; margin: 0 auto; border: 2px dashed #d1d5db; }

        /* Password strength indicator styles */
        #password-strength-bar {
            height: 5px;
            width: 0%;
            border-radius: 2.5px;
            transition: width 0.3s, background-color 0.3s;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="antialiased">

    <!-- Main Application Container -->
    <div id="app" class="min-h-screen relative">

        <!-- Login and Registration Page -->
        <section id="auth-page" class="page flex items-center justify-center min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 space-y-6 transform transition-all duration-500">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-gray-800">Visit Management System</h1>
                    <p class="text-gray-500">Professional visit tracking and management</p>
                </div>

                <div class="flex bg-gray-100 p-1 rounded-lg">
                    <button id="partner-tab" class="w-1/2 p-2 rounded-md text-sm font-semibold text-white bg-indigo-600 shadow focus-ring">Partner</button>
                    <button id="admin-tab" class="w-1/2 p-2 rounded-md text-sm font-semibold text-gray-600 focus-ring">Admin</button>
                </div>

                <div id="partner-form-container">
                    <form id="partner-login-form" class="space-y-4">
                        <h2 class="text-xl font-semibold text-center text-gray-700">Partner Login</h2>
                        <div>
                            <label for="login-email" class="text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus-ring">
                        </div>
                        <div>
                            <label for="login-password" class="text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus-ring">
                        </div>
                        <button type="submit" class="w-full flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus-ring disabled:bg-indigo-400">
                            <span class="btn-text">Sign In</span>
                            <div class="spinner hidden ml-2"></div>
                        </button>
                        <p class="text-center text-sm text-gray-600">
                            Don't have an account? <a href="#" id="show-register-link" class="font-medium text-indigo-600 hover:text-indigo-500">Create Account</a>
                        </p>
                    </form>

                    <form id="partner-register-form" class="hidden space-y-4">
                        <h2 class="text-xl font-semibold text-center text-gray-700">Create Partner Account</h2>
                        <div>
                            <label for="register-fullname" class="text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="register-fullname" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus-ring">
                        </div>
                        <div>
                            <label for="register-username" class="text-sm font-medium text-gray-700">Username</label>
                            <input type="text" id="register-username" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus-ring">
                             <p id="username-error" class="text-xs text-red-500 mt-1 hidden"></p>
                        </div>
                        <div>
                            <label for="register-email" class="text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus-ring">
                        </div>
                        <div>
                            <label for="register-password" class="text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus-ring">
                            <div class="mt-2">
                                <div id="password-strength-bar" class="bg-gray-200"></div>
                                <p id="password-strength-text" class="text-xs text-gray-500 mt-1"></p>
                            </div>
                        </div>
                        <button type="submit" class="w-full flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus-ring disabled:bg-indigo-400">
                            <span class="btn-text">Register</span>
                            <div class="spinner hidden ml-2"></div>
                        </button>
                        <p class="text-center text-sm text-gray-600">
                            Already have an account? <a href="#" id="show-login-link" class="font-medium text-indigo-600 hover:text-indigo-500">Sign In</a>
                        </p>
                    </form>
                </div>

                <form id="admin-login-form" class="hidden space-y-4">
                    <h2 class="text-xl font-semibold text-center text-gray-700">Admin Login</h2>
                    <div>
                        <label for="admin-email" class="text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="admin-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus-ring">
                    </div>
                    <div>
                        <label for="admin-password" class="text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="admin-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus-ring">
                    </div>
                    <button type="submit" class="w-full flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus-ring disabled:bg-indigo-400">
                        <span class="btn-text">Sign In</span>
                        <div class="spinner hidden ml-2"></div>
                    </button>
                </form>
                <p id="auth-error" class="text-center text-sm text-red-500 mt-4"></p>
                <p class="text-center text-xs text-gray-400 mt-6">v3.5</p>
            </div>
        </section>

        <!-- Partner Dashboard Page -->
        <section id="partner-dashboard" class="page hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm sticky top-0 z-10">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center py-3">
                        <div class="flex items-center space-x-4">
                            <span class="font-bold text-lg text-gray-800">Partner Dashboard</span>
                            <span id="user-info" class="text-sm font-medium bg-gray-100 text-gray-700 px-3 py-1 rounded-full"></span>
                            <span id="geo-info" class="text-sm font-medium bg-green-100 text-green-800 px-3 py-1 rounded-full hidden items-center"></span>
                        </div>
                        <button id="logout-btn-partner" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus-ring">Logout</button>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Visits</p>
                            <p id="total-visits-partner" class="text-3xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Today's Visits</p>
                            <p id="today-visits-partner" class="text-3xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Editable Visits</p>
                            <p id="editable-visits-partner" class="text-3xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <!-- New Visit Entry Form -->
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">New Visit Entry</h2>
                    <form id="visit-form" class="space-y-6">
                        <!-- Camera and Photo Section -->
                        <div class="text-center">
                            <div class="w-full max-w-xs mx-auto bg-gray-100 rounded-lg p-2">
                                <video id="cameraFeed" autoplay playsinline class="hidden"></video>
                                <canvas id="photoCanvas"></canvas>
                                <img id="photoPreview" src="https://placehold.co/250x188/e2e8f0/cbd5e0?text=Photo+Required" alt="Photo Preview">
                            </div>
                            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
                                <button type="button" id="start-camera-btn" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 focus-ring">Start Camera</button>
                                <button type="button" id="capture-photo-btn" class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 focus-ring" disabled>Capture Photo</button>
                            </div>
                        </div>

                        <!-- Form Fields -->
                        <div class="space-y-6">
                            <div>
                                <label for="person-name" class="block text-sm font-medium text-gray-700">Person Name</label>
                                <div class="mt-1 relative rounded-md shadow-sm">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                    </div>
                                    <input type="text" id="person-name" required class="block w-full rounded-md border-gray-300 pl-10 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm focus-ring">
                                </div>
                            </div>
                            <div>
                                <label for="mobile-number" class="block text-sm font-medium text-gray-700">Mobile Number</label>
                                <div class="mt-1 relative rounded-md shadow-sm">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3.5A1.5 1.5 0 013.5 2h1.148a1.5 1.5 0 011.465 1.175l.716 3.223a1.5 1.5 0 01-1.052 1.767l-.933.267c-.41.117-.643.555-.48.95a11.542 11.542 0 006.254 6.254c.395.163.833-.07.95-.48l.267-.933a1.5 1.5 0 011.767-1.052l3.223.716A1.5 1.5 0 0118 15.352V16.5A1.5 1.5 0 0116.5 18h-13A1.5 1.5 0 012 16.5v-13z" /></svg>
                                    </div>
                                    <input type="tel" id="mobile-number" required class="block w-full rounded-md border-gray-300 pl-10 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm focus-ring">
                                </div>
                            </div>
                            <div>
                                <label for="company-name" class="block text-sm font-medium text-gray-700">Company Name</label>
                                <div class="mt-1 relative rounded-md shadow-sm">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V8a2 2 0 00-2-2h-5L9 4H4zm4.5 5a.5.5 0 000 1h3a.5.5 0 000-1h-3z" clip-rule="evenodd" /></svg>
                                    </div>
                                    <input type="text" id="company-name" required class="block w-full rounded-md border-gray-300 pl-10 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm focus-ring">
                                </div>
                            </div>
                            <div>
                                <label for="designation" class="block text-sm font-medium text-gray-700">Designation</label>
                                <div class="mt-1 relative rounded-md shadow-sm">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                    </div>
                                    <input type="text" id="designation" required class="block w-full rounded-md border-gray-300 pl-10 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm focus-ring">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="meeting-purpose" class="block text-sm font-medium text-gray-700">Meeting Purpose</label>
                            <textarea id="meeting-purpose" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus-ring"></textarea>
                        </div>
                        <button type="submit" id="submit-visit-btn" class="w-full flex items-center justify-center py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus-ring disabled:bg-gray-400" disabled>
                            <span class="btn-text">Submit Visit</span>
                            <div class="spinner hidden ml-2"></div>
                        </button>
                    </form>
                </div>

                <!-- Visit History Table -->
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Visit History</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Person</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="partner-visits-table" class="bg-white divide-y divide-gray-200">
                                <!-- Rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </section>

        <!-- Admin Dashboard Page -->
        <section id="admin-dashboard" class="page hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm sticky top-0 z-10">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center py-3">
                        <span class="font-bold text-lg text-gray-800">Administrator Dashboard</span>
                        <button id="logout-btn-admin" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus-ring">Logout</button>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <p class="text-sm font-medium text-gray-500">Total Visits</p>
                        <p id="total-visits-admin" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <p class="text-sm font-medium text-gray-500">Registered Partners</p>
                        <p id="total-partners-admin" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <p class="text-sm font-medium text-gray-500">Today's Visits</p>
                        <p id="today-visits-admin" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <p class="text-sm font-medium text-gray-500">Companies</p>
                        <p id="total-companies-admin" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                </div>

                <!-- Registered Partners Table -->
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Registered Partners</h2>
                        <button id="export-partners-btn" class="px-4 py-2 bg-teal-500 text-white rounded-lg font-semibold hover:bg-teal-600 focus-ring">Export All Partners Data</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Registration Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Visits</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Activity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-partners-table" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- All Visits Table -->
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <h2 id="all-visits-header" class="text-2xl font-bold text-gray-800">All Visits</h2>
                        <div class="flex items-center space-x-2">
                            <button id="show-all-visits-btn" class="hidden px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 focus-ring">Show All Visits</button>
                            <button id="export-visits-btn" class="px-4 py-2 bg-teal-500 text-white rounded-lg font-semibold hover:bg-teal-600 focus-ring">Export Displayed Visits</button>
                            <button id="filter-visits-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 focus-ring">Filter Visits</button>
                        </div>
                    </div>
                    <!-- Filter Section (hidden by default) -->
                    <div id="filter-section" class="hidden bg-gray-50 p-4 rounded-lg mb-6 space-y-4 md:space-y-0 md:flex md:items-center md:space-x-4">
                        <input type="date" id="start-date-filter" class="w-full md:w-auto border-gray-300 rounded-md shadow-sm focus-ring">
                        <input type="date" id="end-date-filter" class="w-full md:w-auto border-gray-300 rounded-md shadow-sm focus-ring">
                        <select id="partner-filter" class="w-full md:w-auto border-gray-300 rounded-md shadow-sm focus-ring">
                            <option value="">All Partners</option>
                        </select>
                        <button id="apply-filters-btn" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded-lg focus-ring">Apply</button>
                        <button id="reset-filters-btn" class="w-full md:w-auto px-4 py-2 bg-gray-500 text-white rounded-lg focus-ring">Reset</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Partner</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Person</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mobile</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Photo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-visits-table" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </section>

        <!-- Edit Modal -->
        <div id="edit-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full z-20 flex items-center justify-center">
            <div class="relative mx-auto p-6 border w-full max-w-lg shadow-lg rounded-2xl bg-white">
                <div class="text-center">
                    <h3 class="text-xl leading-6 font-bold text-gray-900">Edit Visit Details</h3>
                    <div class="mt-4 px-7 py-3">
                        <form id="edit-visit-form" class="space-y-4 text-left">
                            <input type="hidden" id="edit-visit-id">
                            <div>
                                <label for="edit-person-name" class="text-sm font-medium">Person Name</label>
                                <input type="text" id="edit-person-name" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus-ring">
                            </div>
                            <div>
                                <label for="edit-mobile-number" class="text-sm font-medium">Mobile Number</label>
                                <input type="tel" id="edit-mobile-number" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus-ring">
                            </div>
                            <div>
                                <label for="edit-company-name" class="text-sm font-medium">Company Name</label>
                                <input type="text" id="edit-company-name" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus-ring">
                            </div>
                            <div>
                                <label for="edit-designation" class="text-sm font-medium">Designation</label>
                                <input type="text" id="edit-designation" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus-ring">
                            </div>
                            <div>
                                <label for="edit-meeting-purpose" class="text-sm font-medium">Meeting Purpose</label>
                                <textarea id="edit-meeting-purpose" rows="3" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus-ring"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="items-center px-4 py-3 space-x-4">
                        <button id="save-edit-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600 focus-ring">Save Changes</button>
                        <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-600 focus-ring">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Universal Modal -->
        <div id="universal-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full z-30 flex items-center justify-center p-4">
            <div class="relative mx-auto p-6 border w-full max-w-sm shadow-lg rounded-2xl bg-white transform transition-all duration-300 scale-95 opacity-0" id="universal-modal-content">
                <div class="text-center">
                    <div id="modal-icon-container" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full">
                        <!-- Icon will be inserted here -->
                    </div>
                    <h3 id="modal-title" class="text-xl leading-6 font-bold text-gray-900 mt-4"></h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="modal-text" class="text-sm text-gray-600"></p>
                    </div>
                    <div id="modal-actions" class="items-center px-4 py-3 space-x-4">
                        <!-- Buttons will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Photo Viewer Modal -->
        <div id="photo-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 z-40 flex items-center justify-center p-4">
            <div class="relative bg-white p-4 rounded-lg shadow-xl max-w-3xl max-h-full">
                <button id="photo-modal-close" class="absolute -top-3 -right-3 h-8 w-8 bg-white rounded-full text-gray-600 hover:text-gray-900 focus-ring">&times;</button>
                <img id="photo-modal-img" src="" alt="Visit Photo" class="max-w-full max-h-[80vh] object-contain">
            </div>
        </div>

    </div>

    <script type="module">
        // =====================================================================================
        // APPLICATION SETUP & CONSTANTS
        // =====================================================================================
        const SUPABASE_URL = 'https://vkoxroooikghnmgedxvk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrb3hyb29vaWtnaG5tZ2VkeHZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNjM5MTksImV4cCI6MjA3MTYzOTkxOX0.XSxM-WsfpT4OGH3xT1AyU2JzUnlQYWnfjlgCH88ZpTw';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const DOM = {
            app: document.getElementById('app'),
            pages: {
                auth: document.getElementById('auth-page'),
                partner: document.getElementById('partner-dashboard'),
                admin: document.getElementById('admin-dashboard'),
            },
            authError: document.getElementById('auth-error'),
        };

        // =====================================================================================
        // APPLICATION STATE
        // =====================================================================================
        let state = {
            currentUser: null,
            userProfile: null,
            userLocation: null,
            capturedPhotoBlob: null,
            cameraStream: null,
            allVisitsData: [],
            allPartnersData: [],
            renderedVisits: [], // For exporting currently displayed data
            activePage: 'auth',
        };

        // =====================================================================================
        // UI & UTILITY FUNCTIONS
        // =====================================================================================

        /**
         * Manages button loading states with a spinner.
         * @param {HTMLButtonElement} button - The button element.
         * @param {boolean} isLoading - Whether to show the loading state.
         */
        const setButtonLoading = (button, isLoading) => {
            if (!button) return;
            const btnText = button.querySelector('.btn-text');
            const spinner = button.querySelector('.spinner');
            if (isLoading) {
                button.disabled = true;
                if(btnText) btnText.classList.add('hidden');
                if(spinner) spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                if(btnText) btnText.classList.remove('hidden');
                if(spinner) spinner.classList.add('hidden');
            }
        };

        /**
         * Switches the visible page with a smooth animation.
         * @param {string} pageName - The name of the page to show ('auth', 'partner', 'admin').
         */
        const showPage = (pageName) => {
            if (state.activePage === pageName && !DOM.pages[pageName].classList.contains('hidden')) return;
            
            Object.values(DOM.pages).forEach(page => page.classList.add('hidden'));
            
            const newPage = DOM.pages[pageName];
            if (newPage) {
                newPage.classList.remove('hidden');
                state.activePage = pageName;
            }
        };

        /**
         * A versatile modal for showing information, success, errors, or confirmations.
         * @param {'info'|'success'|'error'|'confirm'} type - The type of modal.
         * @param {string} title - The title of the modal.
         * @param {string} text - The main message text.
         * @param {Function} [onConfirm] - Callback for the confirm button.
         */
        const showModal = (type, title, text, onConfirm) => {
            const modal = document.getElementById('universal-modal');
            const modalContent = document.getElementById('universal-modal-content');
            const iconContainer = document.getElementById('modal-icon-container');
            const titleEl = document.getElementById('modal-title');
            const textEl = document.getElementById('modal-text');
            const actionsEl = document.getElementById('modal-actions');

            // Reset
            actionsEl.innerHTML = '';
            iconContainer.className = 'mx-auto flex items-center justify-center h-16 w-16 rounded-full';

            // Set content
            titleEl.textContent = title;
            textEl.textContent = text;

            // Set icon and actions based on type
            switch (type) {
                case 'success':
                    iconContainer.classList.add('bg-green-100');
                    iconContainer.innerHTML = `<svg class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
                    actionsEl.innerHTML = `<button id="modal-ok-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus-ring">OK</button>`;
                    break;
                case 'error':
                    iconContainer.classList.add('bg-red-100');
                    iconContainer.innerHTML = `<svg class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
                    actionsEl.innerHTML = `<button id="modal-ok-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus-ring">OK</button>`;
                    break;
                case 'confirm':
                    iconContainer.classList.add('bg-yellow-100');
                    iconContainer.innerHTML = `<svg class="h-8 w-8 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                    actionsEl.innerHTML = `
                        <button id="modal-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 focus-ring">Cancel</button>
                        <button id="modal-confirm-btn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus-ring">Confirm</button>
                    `;
                    break;
            }

            // Show modal with animation
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);

            // Event listeners
            const closeModal = () => {
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            };

            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const confirmBtn = document.getElementById('modal-confirm-btn');

            if (okBtn) okBtn.addEventListener('click', closeModal, { once: true });
            if (cancelBtn) cancelBtn.addEventListener('click', closeModal, { once: true });
            if (confirmBtn && onConfirm) {
                confirmBtn.addEventListener('click', () => {
                    onConfirm();
                    closeModal();
                }, { once: true });
            }
        };

        /**
         * Debounce function to delay execution of a function.
         * @param {Function} func - The function to debounce.
         * @param {number} delay - The delay in milliseconds.
         * @returns {Function} The debounced function.
         */
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };
        
        /**
         * Converts a data URL to a Blob object.
         * @param {string} dataUrl - The data URL to convert.
         * @returns {Blob} The resulting Blob.
         */
        const dataURLtoBlob = (dataUrl) => {
            const arr = dataUrl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        };
        
        /**
         * Exports an array of objects to an Excel file.
         * @param {Array<Object>} data - The data to export.
         * @param {string} filename - The name of the file.
         */
        const exportToExcel = (data, filename) => {
            if (!data || data.length === 0) {
                showModal('error', 'Export Failed', 'There is no data to export.');
                return;
            }
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
            XLSX.writeFile(workbook, `${filename}_${new Date().toISOString().slice(0,10)}.xlsx`);
        };

        // =====================================================================================
        // AUTHENTICATION LOGIC
        // =====================================================================================

        const checkUsernameAvailability = async (username) => {
            const usernameErrorEl = document.getElementById('username-error');
            if (!username) {
                usernameErrorEl.classList.add('hidden');
                return true;
            }
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('username')
                .eq('username', username)
                .maybeSingle();

            if (data) {
                usernameErrorEl.textContent = 'Username is already taken.';
                usernameErrorEl.classList.remove('hidden');
                return false;
            } else {
                usernameErrorEl.classList.add('hidden');
                return true;
            }
        };

        const checkPasswordStrength = (password) => {
            const strengthBar = document.getElementById('password-strength-bar');
            const strengthText = document.getElementById('password-strength-text');
            let score = 0;
            if (password.length > 8) score++;
            if (password.match(/[a-z]/)) score++;
            if (password.match(/[A-Z]/)) score++;
            if (password.match(/[0-9]/)) score++;
            if (password.match(/[^a-zA-Z0-9]/)) score++;

            switch (score) {
                case 0:
                case 1:
                    strengthBar.style.width = '20%';
                    strengthBar.style.backgroundColor = '#ef4444'; // red-500
                    strengthText.textContent = 'Very Weak';
                    break;
                case 2:
                    strengthBar.style.width = '40%';
                    strengthBar.style.backgroundColor = '#f97316'; // orange-500
                    strengthText.textContent = 'Weak';
                    break;
                case 3:
                    strengthBar.style.width = '60%';
                    strengthBar.style.backgroundColor = '#eab308'; // yellow-500
                    strengthText.textContent = 'Moderate';
                    break;
                case 4:
                    strengthBar.style.width = '80%';
                    strengthBar.style.backgroundColor = '#84cc16'; // lime-500
                    strengthText.textContent = 'Strong';
                    break;
                case 5:
                    strengthBar.style.width = '100%';
                    strengthBar.style.backgroundColor = '#22c55e'; // green-500
                    strengthText.textContent = 'Very Strong';
                    break;
                default:
                    strengthBar.style.width = '0%';
                    strengthText.textContent = '';
            }
        };

        document.getElementById('partner-register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            setButtonLoading(submitButton, true);
            DOM.authError.textContent = '';

            const fullName = document.getElementById('register-fullname').value;
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            const isUsernameAvailable = await checkUsernameAvailability(username);
            if (!isUsernameAvailable) {
                setButtonLoading(submitButton, false);
                return;
            }

            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        full_name: fullName,
                        username: username,
                    }
                }
            });

            if (error) {
                DOM.authError.textContent = error.message;
            } else {
                showModal('success', 'Registration Successful!', 'You can now sign in with your new account.');
                document.getElementById('show-login-link').click();
                form.reset();
            }
            setButtonLoading(submitButton, false);
        });

        document.getElementById('partner-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            setButtonLoading(submitButton, true);
            DOM.authError.textContent = '';

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password,
                });

                if (error) {
                    console.error("Login failed:", error.message);
                    DOM.authError.textContent = 'Invalid login credentials. Please try again.';
                } else if (data.user) {
                    state.currentUser = data.user;
                    await fetchUserProfile();
                    await loadPartnerDashboard();
                }
            } catch (err) {
                console.error("Unexpected login error:", err);
                DOM.authError.textContent = 'An unexpected error occurred. Please try again later.';
            } finally {
                setButtonLoading(submitButton, false);
            }
        });
        
        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            setButtonLoading(submitButton, true);
            DOM.authError.textContent = '';

            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password,
                });

                if (error) {
                    console.error("Admin login failed:", error.message);
                    DOM.authError.textContent = 'Invalid admin credentials.';
                    return;
                }

                if (data.user) {
                    const profile = await fetchUserProfile(data.user.id);
                    if (profile && profile.role === 'admin') {
                        state.currentUser = data.user;
                        state.userProfile = profile;
                        await loadAdminDashboard();
                    } else {
                        await supabaseClient.auth.signOut();
                        DOM.authError.textContent = 'Access denied. Not an admin user.';
                    }
                }
            } catch (err) {
                console.error("Unexpected admin login error:", err);
                DOM.authError.textContent = 'An unexpected error occurred. Please try again later.';
            } finally {
                setButtonLoading(submitButton, false);
            }
        });

        const signOut = async () => {
            const { error } = await supabaseClient.auth.signOut();
            state.currentUser = null;
            state.userProfile = null;
            showPage('auth');
        };

        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'INITIAL_SESSION' && session?.user) {
                state.currentUser = session.user;
                await fetchUserProfile();
                if (state.userProfile && state.userProfile.role === 'admin') {
                    await loadAdminDashboard();
                } else {
                    await loadPartnerDashboard();
                }
            } else if (event === 'SIGNED_OUT') {
                state.currentUser = null;
                state.userProfile = null;
                showPage('auth');
            }
        });

        const fetchUserProfile = async (userId = null) => {
            const idToFetch = userId || state.currentUser?.id;
            if (!idToFetch) return null;
            
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('full_name, username, role')
                .eq('id', idToFetch)
                .single();
            
            if (data) {
                state.userProfile = data;
                return data;
            }
            return null;
        };

        // =====================================================================================
        // PARTNER DASHBOARD LOGIC
        // =====================================================================================
        
        const loadPartnerDashboard = async () => {
            showPage('partner');
            document.getElementById('user-info').textContent = state.userProfile?.full_name || state.currentUser.email;
            await getGeoLocation();
            await fetchPartnerStats();
            await fetchPartnerVisits();
        };

        const getGeoLocation = () => {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    showModal('error', 'Geolocation Error', 'Geolocation is not supported by this browser.');
                    return resolve();
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        state.userLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        const geoInfo = document.getElementById('geo-info');
                        geoInfo.innerHTML = `<svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg> <span>${state.userLocation.latitude.toFixed(4)}, ${state.userLocation.longitude.toFixed(4)}</span>`;
                        geoInfo.classList.remove('hidden');
                        geoInfo.classList.add('flex');
                        validateFormCompletion();
                        resolve();
                    },
                    () => {
                        showModal('error', 'Geolocation Error', 'Please enable location access to submit visits.');
                        resolve();
                    }
                );
            });
        };

        const startCamera = async () => {
            const video = document.getElementById('cameraFeed');
            const photoPreview = document.getElementById('photoPreview');
            const captureBtn = document.getElementById('capture-photo-btn');
            try {
                if (state.cameraStream) {
                    state.cameraStream.getTracks().forEach(track => track.stop());
                }
                state.cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = state.cameraStream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    video.classList.remove('hidden');
                    photoPreview.classList.add('hidden');
                    captureBtn.disabled = false;
                };

            } catch (err) {
                console.error("Camera Error:", err);
                showModal('error', 'Camera Error', 'Could not access the camera. Please grant permission or check if another app is using it.');
            }
        };

        const capturePhoto = () => {
            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('photoCanvas');
            const photoPreview = document.getElementById('photoPreview');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const dataUrl = canvas.toDataURL('image/png');
            photoPreview.src = dataUrl;
            state.capturedPhotoBlob = dataURLtoBlob(dataUrl);

            video.classList.add('hidden');
            photoPreview.classList.remove('hidden');
            state.cameraStream.getTracks().forEach(track => track.stop());
            document.getElementById('capture-photo-btn').disabled = true;
            validateFormCompletion();
        };

        const validateFormCompletion = () => {
            const submitBtn = document.getElementById('submit-visit-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            if (state.userLocation && state.capturedPhotoBlob) {
                submitBtn.disabled = false;
                btnText.textContent = 'Submit Visit';
            } else {
                submitBtn.disabled = true;
                let message = 'Required:';
                if (!state.userLocation) message += ' Location';
                if (!state.capturedPhotoBlob) message += ' Photo';
                btnText.textContent = message;
            }
        };

        const fetchPartnerStats = async () => {
            const { count: totalCount } = await supabaseClient
                .from('visits')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', state.currentUser.id);

            const today = new Date().toISOString().slice(0, 10);
            const { count: todayCount } = await supabaseClient
                .from('visits')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', state.currentUser.id)
                .gte('created_at', `${today}T00:00:00.000Z`)
                .lte('created_at', `${today}T23:59:59.999Z`);

            const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString();
            const { count: editableCount } = await supabaseClient
                .from('visits')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', state.currentUser.id)
                .gte('created_at', twoHoursAgo);

            document.getElementById('total-visits-partner').textContent = totalCount || 0;
            document.getElementById('today-visits-partner').textContent = todayCount || 0;
            document.getElementById('editable-visits-partner').textContent = editableCount || 0;
        };
        
        const fetchPartnerVisits = async () => {
            const { data, error } = await supabaseClient
                .from('visits')
                .select('*')
                .eq('user_id', state.currentUser.id)
                .order('created_at', { ascending: false });

            if (error) return;

            const tableBody = document.getElementById('partner-visits-table');
            tableBody.innerHTML = '';
            const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000);

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-500">You haven't submitted any visits yet.</td></tr>`;
                return;
            }

            data.forEach(visit => {
                const isEditable = new Date(visit.created_at) > twoHoursAgo;
                const row = document.createElement('tr');
                row.className = 'text-sm text-gray-700';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${new Date(visit.created_at).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${visit.person_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${visit.company_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="${isEditable ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'} px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                            ${isEditable ? 'Editable' : 'Locked'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button data-id="${visit.id}" class="edit-visit-btn-partner text-indigo-600 hover:text-indigo-900 font-medium ${!isEditable ? 'opacity-50 cursor-not-allowed' : ''}" ${!isEditable ? 'disabled' : ''}>Edit</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            document.querySelectorAll('.edit-visit-btn-partner').forEach(button => {
                button.addEventListener('click', (e) => openEditModal(e.target.dataset.id));
            });
        };

        document.getElementById('visit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-visit-btn');
            setButtonLoading(submitBtn, true);

            const fileName = `${state.currentUser.id}/${Date.now()}.png`;
            const { error: fileError } = await supabaseClient.storage
                .from('visit-photos')
                .upload(fileName, state.capturedPhotoBlob);

            if (fileError) {
                showModal('error', 'Upload Error', 'Failed to upload photo.');
                setButtonLoading(submitBtn, false);
                return;
            }

            const { data: urlData } = supabaseClient.storage.from('visit-photos').getPublicUrl(fileName);

            const visitData = {
                user_id: state.currentUser.id,
                username: state.userProfile.username,
                person_name: document.getElementById('person-name').value,
                mobile_number: document.getElementById('mobile-number').value,
                company_name: document.getElementById('company-name').value,
                designation: document.getElementById('designation').value,
                meeting_purpose: document.getElementById('meeting-purpose').value,
                latitude: state.userLocation.latitude,
                longitude: state.userLocation.longitude,
                photo_url: urlData.publicUrl,
            };

            const { error: insertError } = await supabaseClient.from('visits').insert([visitData]);

            if (insertError) {
                showModal('error', 'Database Error', 'Failed to save visit data. ' + insertError.message);
            } else {
                showModal('success', 'Success!', 'Visit has been successfully submitted.');
                document.getElementById('visit-form').reset();
                state.capturedPhotoBlob = null;
                document.getElementById('photoPreview').src = 'https://placehold.co/250x188/e2e8f0/cbd5e0?text=Photo+Required';
                validateFormCompletion();
                await fetchPartnerStats();
                await fetchPartnerVisits();
            }
            setButtonLoading(submitBtn, false);
        });

        // =====================================================================================
        // ADMIN DASHBOARD LOGIC
        // =====================================================================================
        
        const loadAdminDashboard = async () => {
            showPage('admin');
            const [visits, partners] = await Promise.all([fetchAllVisits(), fetchAllPartners()]);
            state.allVisitsData = visits;
            state.allPartnersData = partners;
            
            renderAdminStats(visits, partners);
            renderPartnersTable(partners, visits);
            renderVisitsTable(visits);
            populatePartnerFilter(partners);
            addAdminTableEventListeners();
        };

        const fetchAllVisits = async () => {
            const { data, error } = await supabaseClient.from('visits').select('*').order('created_at', { ascending: false });
            return error ? [] : data;
        };

        const fetchAllPartners = async () => {
            const { data, error } = await supabaseClient.from('profiles').select('*');
            return error ? [] : data;
        };

        const renderAdminStats = (visits, partners) => {
            document.getElementById('total-visits-admin').textContent = visits.length;
            document.getElementById('total-partners-admin').textContent = partners.length;
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('today-visits-admin').textContent = visits.filter(v => v.created_at.startsWith(today)).length;
            const uniqueCompanies = new Set(visits.map(v => v.company_name));
            document.getElementById('total-companies-admin').textContent = uniqueCompanies.size;
        };

        const renderPartnersTable = (partners, visits) => {
            const tableBody = document.getElementById('admin-partners-table');
            tableBody.innerHTML = '';
            partners.forEach(partner => {
                const partnerVisits = visits.filter(v => v.user_id === partner.id);
                const lastActivity = partnerVisits.length > 0 ? new Date(partnerVisits.sort((a,b) => new Date(b.created_at) - new Date(a.created_at))[0].created_at).toLocaleDateString() : 'N/A';
                const row = `
                    <tr class="text-sm text-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap">${partner.username || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(partner.updated_at).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${partnerVisits.length}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${lastActivity}</td>
                        <td class="px-6 py-4 whitespace-nowrap space-x-2">
                           <button data-username="${partner.username}" class="view-partner-visits-btn text-blue-600 hover:text-blue-900 font-medium">View</button>
                           <button data-username="${partner.username}" class="export-partner-visits-btn text-green-600 hover:text-green-900 font-medium">Export</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        };

        const renderVisitsTable = (visits) => {
            state.renderedVisits = visits; // Store for export
            const tableBody = document.getElementById('admin-visits-table');
            tableBody.innerHTML = '';
            if (visits.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No visits found.</td></tr>';
                return;
            }
            visits.forEach(visit => {
                const row = `
                    <tr class="text-sm text-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap">${visit.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(visit.created_at).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${visit.person_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${visit.mobile_number}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${visit.company_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${visit.latitude.toFixed(4)}, ${visit.longitude.toFixed(4)}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><button data-photo-url="${visit.photo_url}" class="view-photo-btn text-indigo-600 hover:underline">View Photo</button></td>
                        <td class="px-6 py-4 whitespace-nowrap space-x-2">
                            <button data-id="${visit.id}" class="edit-visit-btn-admin text-indigo-600 hover:text-indigo-900 font-medium">Edit</button>
                            <button data-id="${visit.id}" class="delete-visit-btn-admin text-red-600 hover:text-red-900 font-medium">Delete</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        };
        
        const deleteVisit = async (visitId) => {
            showModal('confirm', 'Delete Visit', 'Are you sure you want to permanently delete this visit? This action cannot be undone.', async () => {
                const { error } = await supabaseClient.from('visits').delete().eq('id', visitId);
                if (error) {
                    showModal('error', 'Error', 'Failed to delete visit.');
                } else {
                    showModal('success', 'Success', 'Visit deleted successfully.');
                    loadAdminDashboard();
                }
            });
        };

        // =====================================================================================
        // MODAL & EVENT LISTENERS
        // =====================================================================================
        
        const editModal = document.getElementById('edit-modal');
        
        const openEditModal = async (visitId) => {
            const { data, error } = await supabaseClient.from('visits').select('*').eq('id', visitId).single();
            if (error) return;

            document.getElementById('edit-visit-id').value = data.id;
            document.getElementById('edit-person-name').value = data.person_name;
            document.getElementById('edit-mobile-number').value = data.mobile_number;
            document.getElementById('edit-company-name').value = data.company_name;
            document.getElementById('edit-designation').value = data.designation;
            document.getElementById('edit-meeting-purpose').value = data.meeting_purpose;
            
            editModal.classList.remove('hidden');
        };

        const closeEditModal = () => {
            editModal.classList.add('hidden');
            document.getElementById('edit-visit-form').reset();
        };

        document.getElementById('save-edit-btn').addEventListener('click', async () => {
            const visitId = document.getElementById('edit-visit-id').value;
            const updatedData = {
                person_name: document.getElementById('edit-person-name').value,
                mobile_number: document.getElementById('edit-mobile-number').value,
                company_name: document.getElementById('edit-company-name').value,
                designation: document.getElementById('edit-designation').value,
                meeting_purpose: document.getElementById('edit-meeting-purpose').value,
            };

            const { error } = await supabaseClient.from('visits').update(updatedData).eq('id', visitId);

            if (error) {
                showModal('error', 'Error', 'Failed to update visit.');
            } else {
                showModal('success', 'Success', 'Visit updated successfully.');
                closeEditModal();
                if (state.userProfile.role === 'admin') {
                    loadAdminDashboard();
                } else {
                    fetchPartnerVisits();
                }
            }
        });

        const populatePartnerFilter = (partners) => {
            const filterSelect = document.getElementById('partner-filter');
            if (!filterSelect) return;
            filterSelect.innerHTML = `<option value="">All Partners</option>`;
            partners.forEach(partner => {
                if (partner.username) {
                    const option = document.createElement('option');
                    option.value = partner.username;
                    option.textContent = partner.username;
                    filterSelect.appendChild(option);
                }
            });
        };

        const addAdminTableEventListeners = () => {
            document.getElementById('admin-dashboard').addEventListener('click', (e) => {
                if (e.target.classList.contains('view-partner-visits-btn')) {
                    const username = e.target.dataset.username;
                    const partnerVisits = state.allVisitsData.filter(v => v.username === username);
                    renderVisitsTable(partnerVisits);
                    document.getElementById('all-visits-header').textContent = `Visits by ${username}`;
                    document.getElementById('show-all-visits-btn').classList.remove('hidden');
                }
                if (e.target.classList.contains('export-partner-visits-btn')) {
                    const username = e.target.dataset.username;
                    const partnerVisits = state.allVisitsData.filter(v => v.username === username);
                    exportToExcel(partnerVisits, `visits_${username}`);
                }
                if (e.target.classList.contains('view-photo-btn')) {
                    const photoModal = document.getElementById('photo-modal');
                    const photoImg = document.getElementById('photo-modal-img');
                    photoImg.src = e.target.dataset.photoUrl;
                    photoModal.classList.remove('hidden');
                }
                if (e.target.classList.contains('edit-visit-btn-admin')) {
                    openEditModal(e.target.dataset.id);
                }
                if (e.target.classList.contains('delete-visit-btn-admin')) {
                    deleteVisit(e.target.dataset.id);
                }
            });
        };

        // =====================================================================================
        // INITIALIZATION & GLOBAL EVENT LISTENERS
        // =====================================================================================
        
        const initializeApp = async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                state.currentUser = session.user;
                await fetchUserProfile();
                if (state.userProfile && state.userProfile.role === 'admin') {
                    await loadAdminDashboard();
                } else {
                    await loadPartnerDashboard();
                }
            } else {
                showPage('auth');
            }
        };

        // Auth form toggling
        const partnerFormContainer = document.getElementById('partner-form-container');
        const adminLoginForm = document.getElementById('admin-login-form');
        const partnerTab = document.getElementById('partner-tab');
        const adminTab = document.getElementById('admin-tab');

        partnerTab.addEventListener('click', () => {
            partnerTab.classList.add('bg-indigo-600', 'text-white', 'shadow');
            partnerTab.classList.remove('text-gray-600');
            adminTab.classList.remove('bg-indigo-600', 'text-white', 'shadow');
            adminTab.classList.add('text-gray-600');
            partnerFormContainer.classList.remove('hidden');
            adminLoginForm.classList.add('hidden');
            DOM.authError.textContent = '';
        });

        adminTab.addEventListener('click', () => {
            adminTab.classList.add('bg-indigo-600', 'text-white', 'shadow');
            adminTab.classList.remove('text-gray-600');
            partnerTab.classList.remove('bg-indigo-600', 'text-white', 'shadow');
            partnerTab.classList.add('text-gray-600');
            adminLoginForm.classList.remove('hidden');
            partnerFormContainer.classList.add('hidden');
            DOM.authError.textContent = '';
        });
        
        document.getElementById('show-register-link').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('partner-login-form').classList.add('hidden');
            document.getElementById('partner-register-form').classList.remove('hidden');
            DOM.authError.textContent = '';
        });

        document.getElementById('show-login-link').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('partner-register-form').classList.add('hidden');
            document.getElementById('partner-login-form').classList.remove('hidden');
            DOM.authError.textContent = '';
        });
        
        // Other global listeners
        document.getElementById('logout-btn-partner').addEventListener('click', signOut);
        document.getElementById('logout-btn-admin').addEventListener('click', signOut);
        document.getElementById('start-camera-btn').addEventListener('click', startCamera);
        document.getElementById('capture-photo-btn').addEventListener('click', capturePhoto);
        document.getElementById('cancel-edit-btn').addEventListener('click', closeEditModal);
        document.getElementById('register-username').addEventListener('input', debounce((e) => checkUsernameAvailability(e.target.value), 500));
        document.getElementById('register-password').addEventListener('input', (e) => checkPasswordStrength(e.target.value));
        document.getElementById('photo-modal-close').addEventListener('click', () => {
            document.getElementById('photo-modal').classList.add('hidden');
        });
        document.getElementById('show-all-visits-btn').addEventListener('click', () => {
            renderVisitsTable(state.allVisitsData);
            document.getElementById('all-visits-header').textContent = 'All Visits';
            document.getElementById('show-all-visits-btn').classList.add('hidden');
        });
        document.getElementById('export-partners-btn').addEventListener('click', () => {
            const partnersData = state.allPartnersData.map(p => ({
                Username: p.username,
                'Full Name': p.full_name,
                'Registration Date': new Date(p.updated_at).toLocaleDateString()
            }));
            exportToExcel(partnersData, 'all_partners');
        });
        document.getElementById('export-visits-btn').addEventListener('click', () => {
            exportToExcel(state.renderedVisits, 'displayed_visits');
        });
        document.getElementById('filter-visits-btn').addEventListener('click', () => {
            document.getElementById('filter-section').classList.toggle('hidden');
        });
        document.getElementById('apply-filters-btn').addEventListener('click', () => {
            const startDate = document.getElementById('start-date-filter').value;
            const endDate = document.getElementById('end-date-filter').value;
            const partner = document.getElementById('partner-filter').value;
            let filteredData = [...state.allVisitsData];
            if (startDate) {
                filteredData = filteredData.filter(v => v.created_at.slice(0, 10) >= startDate);
            }
            if (endDate) {
                filteredData = filteredData.filter(v => v.created_at.slice(0, 10) <= endDate);
            }
            if (partner) {
                filteredData = filteredData.filter(v => v.username === partner);
            }
            renderVisitsTable(filteredData);
        });
        document.getElementById('reset-filters-btn').addEventListener('click', () => {
            document.getElementById('start-date-filter').value = '';
            document.getElementById('end-date-filter').value = '';
            document.getElementById('partner-filter').value = '';
            renderVisitsTable(state.allVisitsData);
        });

        initializeApp();

    </script>
</body>
</html>

